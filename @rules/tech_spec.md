# Техническое задание (ТЗ): Мониторинг Roblox-игр с аномалиями онлайна и уведомлениями в Telegram

**ВСЕГДА ГОВОРИ НА РУССКОМ**

## Цель
Разработать скрипт на node js, который:
- Парсит список Roblox-игр с сайта `rotrends.com`.
- Периодически собирает онлайн (CCU) для каждой игры и хранит историю минимум за последние 24 часа.
- Вычисляет статистики (среднее, стандартное отклонение) и выявляет аномальные изменения по правилу: |Δонлайн| > N * σ, где N — чувствительность (например, 2 или 3).
- Отправляет уведомления в Telegram-бота о росте/падении при срабатывании порога, включая ссылку на игру и настраиваемый текст шаблона.
- Выполняет полный цикл проверки всех игр покругу. Тоесть запарсил все игры от а до я, проверил все игры на аномалии и пошел снова по кругу проверять онлайн игр.
- База данных — sqlite

Ссылки-источники для парсинга (известные шаблоны):
- Поиск по ключевому слову с заменой `keyword`: `https://rotrends.com/games?keyword=<слово_или_буква>`
- Пагинация: `https://rotrends.com/games?page=<номер>&page_size=50&sort=-playing`

Примеры (из входных данных):
- `https://rotrends.com/games?keyword=а` — поиск по букве «а»
- `https://rotrends.com/games?keyword=б` — поиск по букве «б»
- `https://rotrends.com/games?page=2&page_size=50&sort=-playing` — переход по страницам

Источники: [`https://rotrends.com/games?keyword=`], [`https://rotrends.com/games?page=3&page_size=50&sort=-playing`]

---

## Глоссарий и определения
- Игра: сущность с уникальным идентификатором, названием, ссылкой на страницу и текущим онлайн (Players/CCU).
- Снимок (snapshot): запись онлайна игры в момент времени (timestamp, ccu).
- Окно истории: последние 24 часа снимков для конкретной игры.
- Аномалия: текущее изменение `Δ = ccu_now − mean(ccu_history)` по модулю превышает `N * stddev(ccu_history)`.
- Чувствительность `N`: настраиваемый множитель (целое/вещественное, типично 2–3).
- Рост/Падение: знак `Δ` (>0 рост, <0 падение).

---

## Ограничения и SLA
- Устойчивость к недоступности источника (ретраи и бэкофф).
- Корректная обработка пустых/обрывистых данных (игнор и логирование).

---


## Архитектура и ключевые компоненты
- **Язык/рантайм**: Node.js (LTS)
- **Хранилище**: `sqlite` (через `better-sqlite3` или `sqlite3`)
- **HTTP-клиент**: `axios` с ретраями и бэкоффом
- **Планировщик задач**: простой цикл с `setInterval`/`await` задержками или `node-cron`
- **Логирование**: `pino` (структурированные логи)
- **Конфигурация**: `.env` + строгая валидация (например, `zod`)
- **Интеграция Telegram**: Bot API (sendMessage), throttle на отправку

### Потоки данных
1. Парсер получает страницы из `rotrends.com` (по буквам и/или пагинации)
2. Извлекает список игр (id, название, ссылка, текущий онлайн)
3. Проверяет и дедуплицирует записи
4. Обновляет справочник игр в БД
5. Снимает «снимок» онлайна и добавляет в БД
6. Для каждой игры рассчитывает статистики по окну 24ч (mean, stddev)
7. Выявляет аномалии по правилу |Δонлайн| > N * σ
8. Отправляет уведомления в Telegram согласно шаблону и настройкам
9. Переходит к следующему циклу (бесконечный обход)

---

## Модель данных (sqlite)
Предпочтительные таблицы и индексы:

1. `games`
   - `id` INTEGER PRIMARY KEY (внутренний автоинкремент)
   - `source_id` TEXT UNIQUE NOT NULL  // устойчивый идентификатор из rotrends/roblox
   - `title` TEXT NOT NULL
   - `url` TEXT NOT NULL
   - `created_at` INTEGER NOT NULL  // epoch ms
   - `updated_at` INTEGER NOT NULL
   - Индексы: UNIQUE(`source_id`)

2. `snapshots`
   - `id` INTEGER PRIMARY KEY
   - `game_id` INTEGER NOT NULL REFERENCES games(id) ON DELETE CASCADE
   - `timestamp` INTEGER NOT NULL  // epoch ms
   - `ccu` INTEGER NOT NULL
   - Индексы: INDEX(`game_id`,`timestamp`), INDEX(`timestamp`)

3. `anomalies`
   - `id` INTEGER PRIMARY KEY
   - `game_id` INTEGER NOT NULL REFERENCES games(id) ON DELETE CASCADE
   - `timestamp` INTEGER NOT NULL  // время обнаружения
   - `delta` REAL NOT NULL  // ccu_now − mean
   - `mean` REAL NOT NULL
   - `stddev` REAL NOT NULL
   - `threshold` REAL NOT NULL  // N * stddev
   - `direction` TEXT NOT NULL  // up|down
   - `notified` INTEGER NOT NULL DEFAULT 0
   - Индексы: INDEX(`game_id`,`timestamp`), INDEX(`notified`)

4. `kv` (опционально, для курсора обхода, версий схемы и пр.)
   - `key` TEXT PRIMARY KEY
   - `value` TEXT NOT NULL

Окно 24ч обеспечивается выборкой `WHERE timestamp >= now - 24h` по `snapshots`.

---

## Стратегия парсинга rotrends
- Источники:
  - По буквам: `https://rotrends.com/games?keyword=<буква>`
  - Пагинация: `https://rotrends.com/games?page=<номер>&page_size=50&sort=-playing`
- Извлечение данных:
  - Если есть открытое API/JSON — использовать его. Если нет — аккуратный HTML-парсинг (например, `cheerio`).
  - Нормализовать `source_id` (стабильный ID игры — из ссылки/атрибутов). Если доступен Roblox placeId — использовать его.
- Дедупликация:
  - Перед вставкой проверять существование `source_id`.
- Ограничение нагрузки:
  - Конкурентность 2–5 запросов, `retry` с экспоненциальным бэкоффом (например, 1000ms * 2^attempt, jitter)

---

## Сбор онлайна (CCU) и расчёты
- Для каждой известной игры периодически создаётся снимок: `(game_id, timestamp, ccu)`
- Источник `ccu` — из той же страницы rotrends; при отсутствии — отдельный запрос при переходе на страницу игры.
- Для статистики по окну 24ч:
  - Выборка всех `snapshots` за последние 24 часа
  - Расчёт `mean` и `stddev` (популяционная или выборочная — фиксировать один вариант; предпочтительно выборочная stddev)
  - `delta = ccu_now − mean`
  - Порог: `threshold = N * stddev`
  - Аномалия, если `Math.abs(delta) > threshold` и есть минимальное кол-во точек в окне (например, ≥ 12)

Пограничные случаи:
- Если stddev = 0 или недостаточно точек — не сигнализируем, только копим историю
- Защита от всплесков-артефактов: медианный фильтр/квантильные отсечения (опционально)

---

## Уведомления в Telegram
- Хранить `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHAT_ID` в `.env`
- Формат сообщения (шаблон, настраиваемый):
  - Пример: `Игра: {title} | Δ: {delta} (Nσ={nSigma}) | CCU: {ccu_now} | mean: {mean} | σ: {stddev} | {url}`
- Анти-спам:
  - Лимит частоты (не более X сообщений/мин)
  - Повторные аномалии того же направления в коротком окне не дублировать (дедуп по ключу `game_id+direction` за T минут)
- Маркировать аномалию как `notified=1` после успешной отправки

---

## Конфигурация
- `.env` параметры:
  - `DB_PATH=./data/monitor.db`
  - `POLL_INTERVAL_MS=60000`  // частота цикла
  - `ANOMALY_N_SIGMA=3`
  - `MIN_POINTS_IN_WINDOW=12`
  - `TELEGRAM_BOT_TOKEN=...`
  - `TELEGRAM_CHAT_ID=...`
  - `CONCURRENCY=3`
  - `REQUEST_TIMEOUT_MS=10000`
  - `RETRY_ATTEMPTS=3`
  - `RETRY_BACKOFF_MS=1000`

Валидация конфигурации при старте, аварийное завершение при критических пропусках.

---

## Логирование и наблюдаемость
- Структурированные логи (уровни: info, warn, error) с ключами: `game_id`, `source_id`, `url`, `attempt`, `duration_ms`
- Метрики (опционально): среднее время запроса, кол-во аномалий за период, размер окна

---

## Производительность и надёжность
- Бэк-офф и ретраи при 4xx/5xx
- Контроль параллелизма запросов
- Очистка старых снапшотов старше 7–30 дней (опционально, чтобы не разрасталась БД)
- Индексация таблиц по частым фильтрам
- Тесты на парсинг и расчёт статистик на синтетике

---

## Минимальные интерфейсы модулей (псевдокод)
- `rotrendsClient.fetchGamesByLetter(letter): Promise<Game[]>`
- `rotrendsClient.fetchGamesByPage(page, pageSize): Promise<Game[]>`
- `db.upsertGame(game)` / `db.insertSnapshot(gameId, ccu)` / `db.getSnapshots(gameId, since)`
- `stats.computeMeanStddev(values)`
- `anomaly.detect(ccuNow, history, nSigma, minPoints)`
- `notifier.sendTelegram(message)`
- `scheduler.runLoop()`

---

## Шаги реализации
1. Инициализация проекта
   - Создать Node.js проект, добавить `typescript`, `ts-node`, `dotenv`, `pino`, `got/axios`, `cheerio`, `better-sqlite3`, `zod`, `node-cron` (или без cron)
   - Настроить `eslint`/`prettier`
   - Добавить `.env.example`
   -Добавить .gitignore

2. Слой конфигурации
   - Реализовать загрузку и валидацию `.env`
   - Экспортировать объект конфигурации

3. Слой БД
   - Создать файл миграции/инициализации схемы с таблицами `games`, `snapshots`, `anomalies`, `kv`
   - Написать DAO-методы: upsert игры, вставка снапшотов, выборка окна за 24ч, запись аномалий

4. Клиент rotrends
   - Реализовать обёртку HTTP с ретраями/таймаутами
   - Реализовать парсинг по буквам и по страницам, нормализацию `source_id`
   - Юнит-тесты на парсинг (на сохранённых фикстурах HTML)

5. Наполнение `games`
   - Пройтись по алфавиту и всем страницам по букве, собрать игры
   - Сохранить/обновить игры в БД, исключая дубликаты

6. Сбор снапшотов
   - Для всех игр снимать `ccu` и писать `snapshots`
   - Обработать ошибки и пропуски без падения цикла

7. Расчёт статистик и аномалий
   - Для каждой игры выбрать окно 24ч, посчитать `mean/stddev`, `delta`, сравнить с порогом
   - Записать аномалии и пометить для нотификации

8. Интеграция Telegram
   - Подключить Bot API, реализовать отправку с шаблоном и лимитом частоты
   - Отмечать `anomalies.notified=1` при успехе

9. Планировщик и главный цикл
   - Реализовать бесконечный цикл: парсинг новых игр → сбор снапшотов → детект → нотификация → пауза
   - Параметризовать интервалы и параллелизм

10. Наблюдаемость и обслуживание
   - Логи, счётчики, ручная команда «перестроить индексы/сжать БД» (опционально)
   - Очистка старых снапшотов по расписанию

11. Документация и запуск
   - Обновить README: как запускать локально/в docker (опционально)
   - Пример `.env`

---

## Критерии готовности (DoD)
- Конфиг валидируется при старте; при ошибках — понятная диагностика
- БД создаётся автоматически, есть индексы, запросы быстрые
- Парсер стабильно обходит все источники и поддерживает ретраи
- Снимки за 24ч сохраняются и корректно выбираются
- Детектор аномалий соответствует формуле и настроечным параметрам
- Уведомления приходят в Telegram с корректным шаблоном и дедупликацией
- Логи информативны, нет немых падений

